{"ast":null,"code":"import{createContext,useState,useEffect}from\"react\";import{initializeApp}from\"firebase/app\";import{getAuth,onAuthStateChanged}from\"firebase/auth\";import LoadingPage from\"../pages/loading\";// Configuração do Firebase\nimport{jsx as _jsx}from\"react/jsx-runtime\";const firebaseConfig={apiKey:process.env.REACT_APP_FIREBASE_API_KEY,authDomain:process.env.REACT_APP_FIREBASE_AUTH_DOMAIN,projectId:process.env.REACT_APP_FIREBASE_PROJECT_ID,storageBucket:process.env.REACT_APP_FIREBASE_STORAGE_BUCKET,messagingSenderId:process.env.REACT_APP_FIREBASE_MESSAGING_SENDER_ID,appId:process.env.REACT_APP_FIREBASE_APP_ID};const app=initializeApp(firebaseConfig);const auth=getAuth(app);export const UserContext=/*#__PURE__*/createContext();export const UserProvider=_ref=>{let{children}=_ref;const[username,setUsername]=useState(null);const[userEmail,setUserEmail]=useState(\"\");const[isAuthenticated,setIsAuthenticated]=useState(false);const[isLoading,setIsLoading]=useState(true);const[userRole,setUserRole]=useState(null);// Função para verificar e validar o token do utilizador\nconst validateUserToken=async user=>{try{const token=await user.getIdToken();const response=await fetch(\"http://192.168.1.219:8080/users/verifyTokenAndGetUserInfo\",{method:\"POST\",headers:{\"Content-Type\":\"application/json\"},body:JSON.stringify({token})});if(response.ok){const userData=await response.json();setUsername(userData.nome);setUserEmail(userData.email);setUserRole(userData.role);setIsAuthenticated(true);return true;}else{// Token inválido\nclearUserData();return false;}}catch(error){console.error(\"Erro ao validar token:\",error);clearUserData();return false;}};// Função para limpar dados do utilizador\nconst clearUserData=()=>{setUsername(null);setUserEmail(\"\");setUserRole(null);setIsAuthenticated(false);};// Função para logout\nconst logout=async()=>{try{await auth.signOut();clearUserData();}catch(error){console.error(\"Erro ao fazer logout:\",error);}};useEffect(()=>{// Observa mudanças no estado de autenticação do Firebase\nconst unsubscribe=onAuthStateChanged(auth,async user=>{setIsLoading(true);if(user){// Utilizador está logado, verificar se o token é válido\nconst isValid=await validateUserToken(user);if(!isValid){// Se o token não for válido, fazer logout\nawait auth.signOut();}}else{// Utilizador não está logado\nclearUserData();}setIsLoading(false);});return()=>unsubscribe();},[]);const value={username,setUsername,userEmail,setUserEmail,userRole,setUserRole,isAuthenticated,isLoading,logout,validateUserToken,auth};// Mostrar página de loading enquanto verifica autenticação\nif(isLoading){return/*#__PURE__*/_jsx(LoadingPage,{});}return/*#__PURE__*/_jsx(UserContext.Provider,{value:value,children:children});};","map":{"version":3,"names":["createContext","useState","useEffect","initializeApp","getAuth","onAuthStateChanged","LoadingPage","jsx","_jsx","firebaseConfig","apiKey","process","env","REACT_APP_FIREBASE_API_KEY","authDomain","REACT_APP_FIREBASE_AUTH_DOMAIN","projectId","REACT_APP_FIREBASE_PROJECT_ID","storageBucket","REACT_APP_FIREBASE_STORAGE_BUCKET","messagingSenderId","REACT_APP_FIREBASE_MESSAGING_SENDER_ID","appId","REACT_APP_FIREBASE_APP_ID","app","auth","UserContext","UserProvider","_ref","children","username","setUsername","userEmail","setUserEmail","isAuthenticated","setIsAuthenticated","isLoading","setIsLoading","userRole","setUserRole","validateUserToken","user","token","getIdToken","response","fetch","method","headers","body","JSON","stringify","ok","userData","json","nome","email","role","clearUserData","error","console","logout","signOut","unsubscribe","isValid","value","Provider"],"sources":["C:/Users/António Gonçalves/Desktop/Magna-ISO9001-Frontend/src/context/userContext.js"],"sourcesContent":["import { createContext, useState, useEffect } from \"react\";\r\nimport { initializeApp } from \"firebase/app\";\r\nimport { getAuth, onAuthStateChanged } from \"firebase/auth\";\r\nimport LoadingPage from \"../pages/loading\";\r\n\r\n// Configuração do Firebase\r\nconst firebaseConfig = {\r\n  apiKey: process.env.REACT_APP_FIREBASE_API_KEY,\r\n  authDomain: process.env.REACT_APP_FIREBASE_AUTH_DOMAIN,\r\n  projectId: process.env.REACT_APP_FIREBASE_PROJECT_ID,\r\n  storageBucket: process.env.REACT_APP_FIREBASE_STORAGE_BUCKET,\r\n  messagingSenderId: process.env.REACT_APP_FIREBASE_MESSAGING_SENDER_ID,\r\n  appId: process.env.REACT_APP_FIREBASE_APP_ID,\r\n};\r\n\r\nconst app = initializeApp(firebaseConfig);\r\nconst auth = getAuth(app);\r\n\r\nexport const UserContext = createContext();\r\n\r\nexport const UserProvider = ({ children }) => {\r\n  const [username, setUsername] = useState(null);\r\n  const [userEmail, setUserEmail] = useState(\"\");\r\n  const [isAuthenticated, setIsAuthenticated] = useState(false);\r\n  const [isLoading, setIsLoading] = useState(true);\r\n  const [userRole, setUserRole] = useState(null);\r\n\r\n  // Função para verificar e validar o token do utilizador\r\n  const validateUserToken = async (user) => {\r\n    try {\r\n      const token = await user.getIdToken();\r\n      const response = await fetch(\"http://192.168.1.219:8080/users/verifyTokenAndGetUserInfo\", {\r\n        method: \"POST\",\r\n        headers: {\r\n          \"Content-Type\": \"application/json\",\r\n        },\r\n        body: JSON.stringify({ token }),\r\n      });\r\n      \r\n      if (response.ok) {\r\n        const userData = await response.json();\r\n        setUsername(userData.nome);\r\n        setUserEmail(userData.email);\r\n        setUserRole(userData.role);\r\n        setIsAuthenticated(true);\r\n        return true;\r\n      } else {\r\n        // Token inválido\r\n        clearUserData();\r\n        return false;\r\n      }\r\n    } catch (error) {\r\n      console.error(\"Erro ao validar token:\", error);\r\n      clearUserData();\r\n      return false;\r\n    }\r\n  };\r\n\r\n  // Função para limpar dados do utilizador\r\n  const clearUserData = () => {\r\n    setUsername(null);\r\n    setUserEmail(\"\");\r\n    setUserRole(null);\r\n    setIsAuthenticated(false);\r\n  };\r\n\r\n  // Função para logout\r\n  const logout = async () => {\r\n    try {\r\n      await auth.signOut();\r\n      clearUserData();\r\n    } catch (error) {\r\n      console.error(\"Erro ao fazer logout:\", error);\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    // Observa mudanças no estado de autenticação do Firebase\r\n    const unsubscribe = onAuthStateChanged(auth, async (user) => {\r\n      setIsLoading(true);\r\n      \r\n      if (user) {\r\n        // Utilizador está logado, verificar se o token é válido\r\n        const isValid = await validateUserToken(user);\r\n        if (!isValid) {\r\n          // Se o token não for válido, fazer logout\r\n          await auth.signOut();\r\n        }\r\n      } else {\r\n        // Utilizador não está logado\r\n        clearUserData();\r\n      }\r\n      \r\n      setIsLoading(false);\r\n    });\r\n\r\n    return () => unsubscribe();\r\n  }, []);\r\n\r\n  const value = {\r\n    username,\r\n    setUsername,\r\n    userEmail,\r\n    setUserEmail,\r\n    userRole,\r\n    setUserRole,\r\n    isAuthenticated,\r\n    isLoading,\r\n    logout,\r\n    validateUserToken,\r\n    auth\r\n  };\r\n\r\n  // Mostrar página de loading enquanto verifica autenticação\r\n  if (isLoading) {\r\n    return <LoadingPage />;\r\n  }\r\n\r\n  return (\r\n    <UserContext.Provider value={value}>\r\n      {children}\r\n    </UserContext.Provider>\r\n  );\r\n};\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}